<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JC Journal</title>
    <link rel="icon" type="image/x-icon" href="icon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
      @font-face {
        font-family: 'GlacialIndifference-Bold';
        src: url('fonts/GlacialIndifference-Bold.otf') format('opentype');
        font-weight: bold;
        font-style: normal;
      }

      .font-inter {
        font-family: 'Inter', sans-serif;
      }
      
      .font-title-custom {
        font-family: 'GlacialIndifference-Bold', sans-serif;
      }

      /* Hide scrollbar while keeping functionality */
      main {
        -ms-overflow-style: none;  /* IE and Edge */
        scrollbar-width: none;  /* Firefox */
      }
      main::-webkit-scrollbar {
        display: none; /* Chrome, Safari and Opera */
      }
      
      /* Simple fade in for views */
      .fade-in {
          animation: fadeIn 0.5s;
      }
      @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
      }

      /* Loading spinner */
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #000;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
</head>
<body class="bg-[#FFFDF3] font-inter text-black h-screen overflow-hidden flex flex-col">

    <div class="container mx-auto p-4 sm:p-8 max-w-6xl flex flex-col h-full">

        <header class="mb-8 flex-shrink-0">
            
            <div class="flex justify-between items-center border-black pb-2 mb-2">
                <!-- Responsive Date Box -->
                <div class="border-2 border-black p-2 sm:p-4 text-center font-bold text-xs w-28 sm:w-44 uppercase cursor-pointer" onclick="window.location.hash=''">
                    <span id="current-date"></span>
                </div>
                
                <!-- Responsive Title - Clicks go Home -->
                <h1 class="font-title-custom text-center text-5xl md:text-7xl lg:text-9xl uppercase mx-2 sm:mx-4 cursor-pointer" onclick="window.location.hash=''">
                        JCJournal
                </h1>
                
                <!-- Responsive Search Box -->
                <input type="text" id="search-input" placeholder="SEARCH" class="border-2 border-black p-2 sm:p-4 text-center font-bold text-xs w-28 sm:w-44 uppercase bg-transparent focus:outline-none focus:ring-2 focus:ring-red-500 transition-all">
            </div>

            <div class="border-b border-black"></div>
            <div class="border-b border-red-500 my-1"></div> 
            <div class="border-b border-black mb-4"></div>


            <p class="text-center text-sm mb-4 max-w-4xl mx-auto">
                Most of important text writings and topical tanigble talking musings about with which the world is revolve. Truth is the most it important of all knowledge.
            </p>

            <div class="border-b border-black"></div>

        </header>

        <!-- DYNAMIC CONTENT AREA -->
        <main id="main-content" class="max-w-4xl mx-auto flex-1 overflow-y-auto w-full relative">
            <!-- Content is injected here by JavaScript -->
            <div class="loader"></div>
            <p id="status-msg" class="text-center text-sm text-gray-500">Connecting to database...</p>
        </main>

        <footer class="border-t border-black pt-6 mt-12 text-center flex-shrink-0">
            <p class="text-xs text-gray-600 uppercase">
                © 2025 JCJournal. All Rights Reserved. 
                <span class="mx-2">|</span> 
                <a href="#submit" class="hover:text-red-500 transition-colors font-bold">Submit Article</a>
            </p>
        </footer>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Configuration ---
        // If running in the chat preview, we use the environment config.
        // If running LOCALLY (on your VPS), we use the object below.
        // PASTE YOUR FIREBASE KEYS INTO THE OBJECT BELOW.
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyBjyAYAyQI4rGQviWbH1Dx8o2hFoe7jAS4",
  				authDomain: "jc-journal.firebaseapp.com",
  				projectId: "jc-journal",
  				storageBucket: "jc-journal.firebasestorage.app",
  				messagingSenderId: "931803753012",
  				appId: "1:931803753012:web:6fc075b16e11bf760ff861"
            };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State ---
        let allArticles = []; 
        let displayedCount = 5; 
        let user = null;
        let currentView = 'home'; 

        // --- DOM Elements ---
        const mainContent = document.getElementById('main-content');
        const dateElement = document.getElementById('current-date');
        const searchInput = document.getElementById('search-input');

        // --- Initialization ---
        async function init() {
            // 1. Set Date
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            dateElement.textContent = today.toLocaleDateString('en-US', options).toUpperCase();

            // 2. Authenticate
            try {
                // If in chat preview, use special token
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    // If on VPS/Local, use Anonymous Auth
                    // NOTE: Enable "Anonymous" sign-in method in Firebase Console -> Authentication
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
                const statusMsg = document.getElementById('status-msg');
                if(statusMsg) statusMsg.innerHTML = `Authentication failed.<br>Check console for details.<br>(${error.code})`;
                return;
            }

            // 3. Auth Listener
            onAuthStateChanged(auth, (u) => {
                user = u;
                if (user) {
                    console.log("Authenticated as:", user.uid);
                    setupDataListener();
                }
            });

            // 4. Handle Routing
            window.addEventListener('hashchange', handleRouting);
            handleRouting(); 
        }

        // --- Routing System ---
        function handleRouting() {
            const hash = window.location.hash;
            if (hash === '' || hash === '#') {
                currentView = 'home';
                if (mainContent) mainContent.scrollTop = 0;
                if (allArticles.length > 0) renderHome();
            } else if (hash === '#submit') {
                currentView = 'submit';
                renderSubmitForm();
            } else if (hash.startsWith('#article/')) {
                currentView = 'article';
                const articleId = hash.split('/')[1];
                if (allArticles.length > 0) renderArticleDetail(articleId);
            }
        }

        // --- Data Management ---
        function setupDataListener() {
            // Use simple 'articles' collection for local/VPS usage
            // Use 'artifacts' path for chat environment compatibility
            let collectionPath = 'articles';
            if (typeof __app_id !== 'undefined') {
                 // We are in chat environment, use strict path
                 // This logic allows the code to run in BOTH places
            }
            
            // For simplicity in this hybrid file, we will determine the reference dynamically
            let articlesRef;
            if (typeof __app_id !== 'undefined') {
                articlesRef = collection(db, 'artifacts', __app_id, 'public', 'data', 'articles');
            } else {
                // YOUR VPS/LOCAL PATH
                articlesRef = collection(db, 'articles');
            }
            
            onSnapshot(articlesRef, async (snapshot) => {
                allArticles = [];
                snapshot.forEach((doc) => {
                    allArticles.push({ id: doc.id, ...doc.data() });
                });

                // Auto-seed only if empty and we have the function

                // Sort newest first
                allArticles.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

                // Re-render current view
                if (currentView === 'home') {
                    renderHome();
                } else if (currentView === 'article') {
                    const hash = window.location.hash;
                    const articleId = hash.split('/')[1];
                    renderArticleDetail(articleId);
                }
            }, (error) => {
                console.error("Error fetching articles:", error);
                mainContent.innerHTML = `<div class="text-center text-red-500 mt-10">Error connecting to database.<br>Check your Firebase Config and Firestore Rules.</div>`;
            });
        }

        // --- View: Home ---
        function renderHome() {
            const searchTerm = searchInput.value.toLowerCase();
            const filteredArticles = allArticles.filter(a => 
                (a.title && a.title.toLowerCase().includes(searchTerm)) || 
                (a.summary && a.summary.toLowerCase().includes(searchTerm))
            );

            const articlesToShow = filteredArticles.slice(0, displayedCount);
            
            if (articlesToShow.length === 0 && allArticles.length > 0) {
                mainContent.innerHTML = `<div class="text-center py-10 text-xl font-bold">No articles found.</div>`;
                return;
            }

            let html = `<div class="fade-in space-y-10">`;

            articlesToShow.forEach(article => {
                const isGrayscale = article.isGrayscale !== undefined ? article.isGrayscale : false;
                
                html += `
                <article class="flex flex-col sm:flex-row items-start border-b border-gray-200 pb-10 last:border-0">
                    <a href="#article/${article.id}" class="flex-shrink-0 w-full sm:w-48 cursor-pointer">
                        <img src="${article.imageUrl || 'https://placehold.co/192x128/cccccc/000000?text=No+Image&font=inter'}" 
                             alt="Thumbnail" 
                             class="w-full h-48 sm:h-32 object-cover rounded mb-4 sm:mb-0 ${isGrayscale ? 'grayscale' : ''} hover:grayscale-0 transition-all duration-300">
                    </a>
                    <div class="sm:ml-6 w-full">
                        <a href="#article/${article.id}">
                            <h2 class="text-2xl font-bold mb-2 uppercase tracking-wide transition-colors cursor-pointer hover:text-gray-600">
                                ${article.title || 'Untitled Article'}
                            </h2>
                        </a>
                        <p class="text-base mb-3 text-gray-800">
                            ${article.summary || 'No summary available.'}
                        </p>
                        <div class="flex items-center space-x-3">
                            <a href="#article/${article.id}" class="bg-black text-white text-xs font-bold py-2 px-4 uppercase tracking-wider hover:bg-gray-800 transition-colors">
                                Read More
                            </a>
                            <span class="text-sm text-gray-600">by ${article.author || 'Unknown'}</span>
                        </div>
                    </div>
                </article>
                `;
            });

            if (articlesToShow.length < filteredArticles.length) {
                html += `<div id="scroll-trigger" class="text-center text-gray-500 py-8 font-bold">Scroll for more...</div>`;
            }

            html += `</div>`;
            mainContent.innerHTML = html;
        }

        // --- View: Article Detail ---
        function renderArticleDetail(id) {
            const article = allArticles.find(a => a.id === id);
            
            if (!article) {
                mainContent.innerHTML = `<div class="text-center mt-20">Loading article...</div>`;
                return;
            }

            const paragraphs = article.content 
                ? article.content.split('\n').map(p => p.trim()).filter(p => p).map(p => `<p class="mb-4">${p}</p>`).join('')
                : '<p>No content.</p>';

            mainContent.innerHTML = `
                <div class="fade-in pb-20">
                    <a href="#" class="inline-block mb-6 text-sm font-bold uppercase border-b border-black hover:text-red-500">← Back to Home</a>
                    
                    <h1 class="text-4xl sm:text-6xl font-bold uppercase mb-4 font-title-custom leading-tight">${article.title}</h1>
                    
                    <div class="flex items-center space-x-2 text-sm text-gray-600 mb-8 border-b border-black pb-4">
                        <span class="font-bold text-black uppercase">By ${article.author}</span>
                        <span>•</span>
                        <span>${new Date(article.createdAt).toLocaleDateString()}</span>
                    </div>

                    <img src="${article.imageUrl || 'https://placehold.co/800x400/cccccc/000000?text=No+Image'}" 
                         class="w-full h-auto max-h-[500px] object-cover mb-8 rounded ${article.isGrayscale ? 'grayscale' : ''}">

                    <div class="prose prose-lg max-w-none font-inter text-gray-800 leading-relaxed">
                        <p class="font-bold text-xl mb-6 italic">${article.summary}</p>
                        ${paragraphs}
                    </div>
                </div>
            `;
        }

        // --- View: Submission Form ---
        function renderSubmitForm() {
            mainContent.innerHTML = `
                <div class="fade-in max-w-2xl mx-auto bg-white p-8 border-2 border-black mb-20">
                    <h2 class="text-3xl font-bold uppercase mb-6 text-center font-title-custom">Submit New Article</h2>
                    
                    <form id="article-form" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold uppercase mb-1">Article Title</label>
                            <input type="text" id="title" required class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500 placeholder-gray-400" placeholder="e.g. THE STATE OF THE WORLD">
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold uppercase mb-1">Author Name</label>
                                <input type="text" id="author" required class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500" placeholder="Your Name">
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase mb-1">Image URL</label>
                                <input type="text" id="imageUrl" placeholder="https://..." class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500">
                                <p class="text-[10px] text-gray-500 mt-1">Paste a link to an image (Imgur, etc)</p>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold uppercase mb-1">Short Summary</label>
                            <textarea id="summary" rows="2" required class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500" placeholder="Appears on the homepage..."></textarea>
                        </div>

                        <div>
                            <label class="block text-xs font-bold uppercase mb-1">Full Content</label>
                            <textarea id="content" rows="10" required class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500" placeholder="Write your article here..."></textarea>
                        </div>

                        <div class="pt-4 flex justify-between items-center">
                            <a href="#" class="text-sm font-bold uppercase hover:text-red-500">Cancel</a>
                            <button type="submit" class="bg-black text-white font-bold uppercase py-3 px-8 hover:bg-gray-800 transition-colors">
                                Publish
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.getElementById('article-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button');
                const originalText = btn.textContent;
                btn.textContent = "Publishing...";
                btn.disabled = true;

                try {
                    // Dynamic Collection Reference (Chat vs Local)
                    let collectionRef;
                    if (typeof __app_id !== 'undefined') {
                         collectionRef = collection(db, 'artifacts', __app_id, 'public', 'data', 'articles');
                    } else {
                         collectionRef = collection(db, 'articles');
                    }
                    
                    await addDoc(collectionRef, {
                        title: document.getElementById('title').value,
                        author: document.getElementById('author').value,
                        imageUrl: document.getElementById('imageUrl').value,
                        summary: document.getElementById('summary').value,
                        content: document.getElementById('content').value,
                        createdAt: Date.now(),
                        submitterId: user.uid, 
                        isGrayscale: false 
                    });
                    
                    alert("Article Published Successfully!");
                    window.location.hash = ''; 
                } catch (error) {
                    console.error("Error submitting:", error);
                    alert(`Error: ${error.code || error.message}`);
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            });
        }

        // --- Helper: Seed Database ---
        async function seedDatabase(ref) {
            console.log("Seeding database...");
            // Short timeout to ensure we don't flood or race condition
            await new Promise(resolve => setTimeout(resolve, 1000));
           
            }

        // --- Event Listeners ---
        searchInput.addEventListener('input', () => {
            displayedCount = 5; 
            if (currentView === 'home') renderHome();
        });

        mainContent.addEventListener('scroll', () => {
            if (currentView !== 'home') return;

            const scrollTrigger = document.getElementById('scroll-trigger');
            if (scrollTrigger) {
                const triggerTop = scrollTrigger.getBoundingClientRect().top;
                const containerBottom = mainContent.getBoundingClientRect().bottom;

                if (triggerTop < containerBottom + 100) {
                    // Debounce/limit updates
                    if (displayedCount < allArticles.length) {
                         displayedCount += 5; 
                         renderHome();
                    }
                }
            }
        });

        init();
    </script>
</body>
</html>