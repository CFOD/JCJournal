<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>JCJournal</title>
        <link rel="icon" type="image/x-icon" href="icon.ico" />
        
        <!-- 1. Load External Config (If available) -->
        <script src="config.js"></script>

        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap"
            rel="stylesheet"
        />

        <style>
            @font-face {
                font-family: "GlacialIndifference-Bold";
                src: url("fonts/GlacialIndifference-Bold.otf")
                    format("opentype");
                font-weight: bold;
                font-style: normal;
            }
            .font-inter {
                font-family: "Inter", sans-serif;
            }
            .font-title-custom {
                font-family: "GlacialIndifference-Bold", sans-serif;
                /* Fallback if local font fails */
                font-weight: 900;
            }

            .fade-in {
                animation: fadeIn 0.5s;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            .loader {
                border: 4px solid #f3f3f3;
                border-top: 4px solid #000;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                animation: spin 1s linear infinite;
                margin: 20px auto;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            /* Config Error Overlay */
            #config-error-overlay {
                display: none;
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(255,255,255,0.95); z-index: 9999;
                flex-direction: column; justify-content: center; align-items: center;
                text-align: center; padding: 20px;
            }

            /* Article Formatting */
            .article-body {
                overflow-wrap: break-word;
                word-wrap: break-word;
                word-break: normal;
                max-width: 100%;
            }

            .article-text-block {
                white-space: pre-wrap;
                margin-bottom: 0;
                line-height: 1.6;
                min-height: 1.2em; 
            }

            .article-body ul {
                list-style-type: disc;
                padding-left: 2rem;
                margin-bottom: 1em;
            }
            .article-body li {
                margin-bottom: 0.25rem;
            }
            .article-body strong {
                font-weight: 700;
            }
            
            /* Inline Image Styles */
            .article-inline-figure {
                margin: 2rem 0;
                width: 100%;
                position: relative; 
            }
            .article-inline-image {
                width: 100%;
                height: auto;
                border-radius: 0.5rem;
                display: block;
            }
            .article-inline-caption {
                text-align: center;
                font-size: 0.875rem;
                color: #6b7280;
                margin-top: 0.5rem;
                font-style: italic;
            }
            .article-image-copyright {
                position: absolute;
                bottom: 0;
                left: 0;
                background-color: rgba(0, 0, 0, 0.6);
                color: white;
                padding: 4px 8px;
                font-size: 10px;
                border-bottom-left-radius: 0.5rem; 
                border-top-right-radius: 0.25rem;
                pointer-events: none;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }
            
            /* Utility */
            .hidden { display: none; }
        </style>
    </head>
    <body class="bg-[#FFFDF3] font-inter text-black flex flex-col min-h-screen">
        
        <!-- Config Error Overlay -->
        <div id="config-error-overlay">
            <h1 class="text-4xl font-bold text-red-600 mb-4">CONFIGURATION MISSING</h1>
            <p class="text-xl mb-4">The website cannot find your <code>config.js</code> file.</p>
            <div class="bg-gray-100 p-4 rounded border border-gray-400 text-left font-mono text-sm mb-6">
                1. Ensure you have created a file named <strong>config.js</strong>.<br>
                2. Ensure it is in the same folder as this HTML file.<br>
                3. Ensure it contains your Firebase Keys (window.siteConfig = ...).<br>
                4. Refresh the page.
            </div>
            <button onclick="location.reload()" class="bg-black text-white px-6 py-2 font-bold uppercase hover:bg-gray-800">I Fixed It, Refresh</button>
        </div>

        <div class="container mx-auto p-4 sm:p-8 max-w-6xl flex-grow">
            <header class="mb-8">
                <div
                    class="flex flex-col lg:flex-row justify-between items-center border-black pb-4 mb-4 lg:pb-2 lg:mb-2 gap-6 lg:gap-0"
                >
                    <!-- Top Row on Mobile: Date & Search -->
                    <div
                        class="w-full lg:w-auto flex justify-between items-center order-1 lg:order-1 lg:contents"
                    >
                        <!-- Date Box -->
                        <div
                            class="order-1 border-2 border-black p-2 sm:p-4 text-center font-bold text-xs w-32 sm:w-44 uppercase cursor-pointer flex items-center justify-center hover:bg-black hover:text-white transition-colors"
                            onclick="resetHome()"
                        >
                            <span id="current-date"></span>
                        </div>

                        <!-- Search Box -->
                        <input
                            type="text"
                            id="search-input"
                            placeholder="SEARCH"
                            class="order-2 lg:order-3 border-2 border-black p-2 sm:p-4 text-center font-bold text-xs w-32 sm:w-44 uppercase bg-transparent focus:outline-none focus:ring-2 focus:ring-red-500 transition-all placeholder-black"
                        />
                    </div>

                    <!-- Title -->
                    <h1
                        class="order-2 lg:order-2 font-title-custom text-center text-6xl sm:text-8xl lg:text-9xl uppercase mx-0 lg:mx-4 cursor-pointer leading-none w-full lg:w-auto hover:text-gray-700 transition-colors"
                        onclick="resetHome()"
                    >
                        JCJournal
                    </h1>

                    <script>
                        (function () {
                            const d = new Date();
                            const ops = {
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                            };
                            document.getElementById(
                                "current-date",
                            ).textContent = d
                                .toLocaleDateString("en-US", ops)
                                .toUpperCase();
                        })();
                    </script>
                </div>

                <div class="border-b border-black"></div>
                <div class="border-b border-red-500 my-1"></div>
                <div class="border-b border-black mb-4"></div>
                <p
                    class="text-center text-sm mb-4 max-w-4xl mx-auto px-4 italic text-gray-700"
                >
                    A digital record of thoughts, theories, and written words.<br>
                    Mondays and Thursdays at 7pm UTC
                </p>
                <div class="border-b border-black"></div>
            </header>

            <main
                id="main-content"
                class="max-w-4xl mx-auto w-full relative min-h-[300px]"
            >
                <div class="loader"></div>
                <p id="status-msg" class="text-center text-sm text-gray-500">
                    Connecting to database...
                </p>
            </main>
        </div>

        <footer
            class="border-t border-black pt-6 pb-10 mt-12 text-center relative bg-[#FFFDF3]"
        >
            <p class="text-xs text-gray-600 uppercase" id="footer-links">
                © 2025 JCJournal. All Rights Reserved.
            </p>
        </footer>

        <!-- Firebase SDKs -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import {
                getAuth,
                onAuthStateChanged,
                signInWithEmailAndPassword,
                signOut,
                setPersistence,
                browserLocalPersistence,
            } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import {
                getFirestore,
                collection,
                addDoc,
                updateDoc,
                deleteDoc, 
                onSnapshot,
                doc,
                getDoc,
                getDocs, 
                setDoc,
            } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            // =================================================================
            //  CONFIGURATION LOGIC
            // =================================================================
            
            let firebaseConfig;
            
            if (window.siteConfig) {
                // User has config.js
                firebaseConfig = window.siteConfig;
            } else if (typeof __firebase_config !== 'undefined') {
                // Fallback: Chat environment
                try {
                    firebaseConfig = JSON.parse(__firebase_config);
                } catch(e) {}
            } else {
                // Fail case
                firebaseConfig = { apiKey: "MISSING" };
            }

            // =================================================================

            let app, auth, db;

            try {
                if (firebaseConfig.apiKey === "MISSING") {
                    // No overlay, silent failure or console log
                    console.warn("Configuration Missing: Create config.js or paste keys.");
                } else {
                    app = initializeApp(firebaseConfig);
                    auth = getAuth(app);
                    db = getFirestore(app);

                    setPersistence(auth, browserLocalPersistence).catch((e) =>
                        console.error("Persistence Error:", e),
                    );
                }
            } catch (e) {
                console.error("Firebase Init Error:", e);
            }

            let allArticles = [];
            let displayedCount = 5;
            let currentUser = null;
            let currentView = "home";
            // Author Filter State
            let currentAuthorFilter = null; 
            let dataListenerUnsubscribe = null;

            const mainContent = document.getElementById("main-content");
            const searchInput = document.getElementById("search-input");

            // Global Helper for Series Search
            window.setSearch = function(term) {
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = term;
                    // Trigger the search logic manually
                    searchInput.dispatchEvent(new Event('input'));
                    window.location.hash = ''; // Ensure we are on home view
                    window.scrollTo(0,0);
                }
            };
            
            // Global Helper to Reset Home (Clear search and go to home)
            window.resetHome = function() {
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.dispatchEvent(new Event('input'));
                }
                window.location.hash = '';
            };

            async function init() {
                if (!auth) {
                    const msg = document.getElementById('status-msg');
                    if (msg) msg.innerText = "Error: App not initialized (Check Config)";
                    return;
                }

                onAuthStateChanged(auth, (user) => {
                    currentUser = user;
                    updateFooterState();
                    if (!dataListenerUnsubscribe) {
                        setupDataListener();
                    } else {
                        // Refresh home to apply new visibility rules
                        if (currentView === "home") renderHome();
                    }
                });

                window.addEventListener("hashchange", handleRouting);
                setTimeout(handleRouting, 100);

                // Global Window Scroll for Infinite Loading
                window.addEventListener("scroll", () => {
                    if (currentView !== "home") return;
                    const st = document.getElementById("scroll-trigger");
                    if (st) {
                        const rect = st.getBoundingClientRect();
                        if (rect.top < window.innerHeight + 100) {
                            if (displayedCount < allArticles.length) {
                                displayedCount += 5;
                                renderHome();
                            }
                        }
                    }
                });
            }

            function updateFooterState() {
                const footerLinks = document.getElementById("footer-links");
                if (!footerLinks) return;

                const user = currentUser || auth.currentUser;
                const baseFooter = "© 2025 JCJournal. All Rights Reserved.";
                const contactLink = `<a href="mailto:contact@jcjournal.com" class="hover:text-gray-700 transition-colors">Contact</a>`;

                if (user) {
                    footerLinks.innerHTML = `
                    ${baseFooter}
                    <span class="mx-2">|</span>
                    ${contactLink}
                    <span class="mx-2">|</span>
                    <a href="#submit" class="hover:text-gray-700 transition-colors font-bold">Submit Article</a>
                    <span class="mx-2">|</span>
                    <a href="#logout" class="hover:text-gray-700 transition-colors">Logout</a>
                `;
                } else {
                    footerLinks.innerHTML = `
                    ${baseFooter}
                    <span class="mx-2">|</span>
                    ${contactLink}
                    <span class="mx-2">|</span>
                    <a href="#login" class="hover:text-gray-700 transition-colors font-bold">Staff Login</a>
                `;
                }
            }

            function handleRouting() {
                const hash = window.location.hash;
                updateFooterState();
                window.scrollTo(0, 0);

                // Clear author filter on nav unless we are navigating TO an author page
                if (!hash.startsWith('#author/')) {
                    currentAuthorFilter = null;
                }

                if (hash === "" || hash === "#") {
                    currentView = "home";
                    // Reset displayed count on home nav so lazy load works again
                    displayedCount = 5;
                    if (allArticles.length > 0) renderHome();
                } else if (hash.startsWith('#author/')) {
                    // AUTHOR FILTER ROUTE
                    currentView = "home";
                    displayedCount = 5;
                    // Decode URI component to handle spaces/special chars in names
                    currentAuthorFilter = decodeURIComponent(hash.split('/')[1]);
                    if (allArticles.length > 0) renderHome();
                } else if (hash === "#login") {
                    currentView = "login";
                    renderLoginForm();
                } else if (hash === "#submit") {
                    if (!auth.currentUser && !currentUser) {
                        window.location.hash = "#login";
                        return;
                    }
                    currentView = "submit";
                    renderSubmitForm();
                } else if (hash.startsWith("#edit/")) {
                    if (!auth.currentUser && !currentUser) {
                        window.location.hash = "#login";
                        return;
                    }
                    currentView = "submit";
                    const articleId = hash.split("/")[1];
                    renderSubmitForm(articleId);
                } else if (hash.startsWith("#article/")) {
                    currentView = "article";
                    const articleId = hash.split("/")[1];
                    if (allArticles.length > 0) renderArticleDetail(articleId);
                } else if (hash === "#logout") {
                    signOut(auth).then(() => {
                        currentUser = null;
                        window.location.hash = "";
                    });
                }
            }

            function setupDataListener() {
                let articlesRef;
                if (window.siteConfig) {
                    articlesRef = collection(db, "articles");
                } else if (typeof __app_id !== 'undefined') {
                    // Chat environment fallback
                     articlesRef = collection(db, 'artifacts', __app_id, 'public', 'data', 'articles');
                } else {
                    articlesRef = collection(db, "articles");
                }

                dataListenerUnsubscribe = onSnapshot(
                    articlesRef,
                    async (snapshot) => {
                        allArticles = [];
                        snapshot.forEach((doc) => {
                            allArticles.push({ id: doc.id, ...doc.data() });
                        });

                        if (allArticles.length === 0) {
                            if (currentView === "home") {
                                mainContent.innerHTML = `<div class="text-center py-10 text-xl font-bold">No articles yet.<br><span class="text-sm font-normal">Login to post the first one.</span></div>`;
                            }
                            return;
                        }

                        // Use scheduledAt if available, otherwise createdAt
                        allArticles.sort(
                            (a, b) => {
                                const dateA = (a.status === 'scheduled' && a.scheduledAt) ? a.scheduledAt : a.createdAt;
                                const dateB = (b.status === 'scheduled' && b.scheduledAt) ? b.scheduledAt : b.createdAt;
                                return (dateB || 0) - (dateA || 0); // Descending (Newest first)
                            }
                        );

                        if (currentView === "home") renderHome();
                        else if (currentView === "article") {
                            const articleId =
                                window.location.hash.split("/")[1];
                            renderArticleDetail(articleId);
                        }
                    },
                    (error) => {
                        console.error("Error fetching articles:", error);
                        let msg = "Error connecting to database.";
                        if (error.code === "permission-denied") {
                            msg =
                                "Permission Denied.<br>Ensure Firestore Rules allow public read access.";
                        }
                        mainContent.innerHTML = `<div class="text-center text-red-500 mt-10">${msg}</div>`;
                    },
                );
            }

            // AUTO-SUMMARY GENERATOR
            function getSnippet(text, maxLength = 200) {
                if (!text) return "No preview available.";
                
                // 1. Remove IMAGE: lines
                let clean = text.replace(/^IMAGE:.*$/gm, "");
                
                // 2. Remove formatting symbols (**, -, *)
                clean = clean.replace(/\*\*/g, "");
                clean = clean.replace(/^[\-\*•]\s+/gm, "");
                
                // 3. Collapse whitespace (newlines to spaces)
                clean = clean.replace(/\s+/g, " ").trim();
                
                if (clean.length <= maxLength) return clean;
                return clean.substring(0, maxLength).trim() + "...";
            }

            function formatArticleText(text) {
                if (!text) return "<p>No content.</p>";

                const lines = text.split("\n");
                let html = "";
                let inList = false;

                const processFormatting = (str) => {
                    // Replace **text** with <strong>text</strong>
                    return str.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>");
                };

                lines.forEach((line) => {
                    const trimmed = line.trim();
                    
                    // 1. Check for IMAGE: syntax
                    const imgMatch = trimmed.match(/^IMAGE:\s*(https?:\/\/\S+)(.*)?$/i);
                    
                    if (imgMatch) {
                        if (inList) { html += "</ul>"; inList = false; }
                        
                        const url = imgMatch[1];
                        const rest = imgMatch[2] || '';
                        const parts = rest.split('|');
                        
                        let caption = '';
                        let copyright = '';
                        
                        if (parts.length > 1) {
                            caption = parts[1].trim();
                        }
                        if (parts.length > 2) {
                            copyright = parts[2].trim();
                        }
                        
                        html += `
                        <figure class="article-inline-figure">
                            <img src="${url}" 
                                 referrerpolicy="no-referrer" 
                                 class="article-inline-image" 
                                 alt="${caption}"
                                 onerror="this.onerror=null; this.src='https://placehold.co/800x400/cccccc/000000?text=Image+Unavailable';">
                            ${copyright ? `<div class="article-image-copyright">${copyright}</div>` : ''}
                            ${caption ? `<figcaption class="article-inline-caption">${caption}</figcaption>` : ''}
                        </figure>
                        `;
                        return; // Skip rest of loop for this line
                    }

                    // 2. Check for List items
                    const listMatch = line.match(/^[\-\*]\s+(.*)/);
                    if (listMatch) {
                        if (!inList) {
                            html += '<ul class="list-disc pl-5 mb-4">';
                            inList = true;
                        }
                        html += `<li class="mb-1">${processFormatting(listMatch[1])}</li>`;
                    } else {
                        if (inList) {
                            html += "</ul>";
                            inList = false;
                        }
                        const formattedLine = processFormatting(line);
                        html += `<div class="article-text-block">${formattedLine || "&nbsp;"}</div>`;
                    }
                });

                if (inList) html += "</ul>";
                return html;
            }

            // === CORE LOGIC: Determines if article is visible ===
            function isArticleVisible(article) {
                if (currentUser) return true;
                if (article.status === 'draft') return false;

                if (article.status === 'scheduled') {
                    const scheduledTime = article.scheduledAt || 0;
                    const now = Date.now();
                    return now >= scheduledTime;
                }
                return true;
            }

            function renderHome() {
                const searchTerm = searchInput.value.toLowerCase();
                const filteredArticles = allArticles.filter((a) => {
                    // Check visibility logic first
                    if (!isArticleVisible(a)) return false;
                    
                    // NEW: Author Filter Check
                    if (currentAuthorFilter && a.author !== currentAuthorFilter) return false;

                    // Use effective date for search/display
                    const effectiveDate = (a.status === 'scheduled' && a.scheduledAt) ? a.scheduledAt : a.createdAt;
                    const dateStr = new Date(effectiveDate)
                        .toLocaleDateString()
                        .toLowerCase();
                        
                    return (
                        (a.title &&
                            a.title.toLowerCase().includes(searchTerm)) ||
                        // Search the content now since we auto-generate summary if manual summary is missing
                        (a.content &&
                            a.content.toLowerCase().includes(searchTerm)) ||
                        (a.summary && 
                            a.summary.toLowerCase().includes(searchTerm)) ||
                        (a.author &&
                            a.author.toLowerCase().includes(searchTerm)) ||
                        (a.series &&
                            a.series.toLowerCase().includes(searchTerm)) || // Added Series to search
                        dateStr.includes(searchTerm)
                    );
                });

                const articlesToShow = filteredArticles.slice(
                    0,
                    displayedCount,
                );
                
                // Show Author Filter Header
                let headerHtml = "";
                if (currentAuthorFilter) {
                    headerHtml = `
                        <div class="mb-8 pb-4 border-b border-gray-300 flex justify-between items-center">
                            <span class="text-xl font-bold uppercase">ARTICLES BY: <span class="text-red-600">${currentAuthorFilter}</span></span>
                            <a href="#" class="text-xs uppercase bg-black text-white px-3 py-1 hover:bg-gray-800 transition-colors">Clear Filter</a>
                        </div>
                    `;
                }

                if (articlesToShow.length === 0) {
                    if (allArticles.length === 0) {
                        mainContent.innerHTML = `<div class="text-center py-10 text-xl font-bold">No articles yet.<br><span class="text-sm font-normal">Login to post the first one.</span></div>`;
                    } else {
                        mainContent.innerHTML = `${headerHtml}<div class="text-center py-10 text-xl font-bold">No articles found.</div>`;
                    }
                    return;
                }

                let html = `<div class="fade-in space-y-10">`;
                html = headerHtml + html;
                
                articlesToShow.forEach((article) => {
                    let badge = '';
                    let opacityClass = '';
                    
                    // STAFF VIEW BADGES
                    if (currentUser) {
                        if (article.status === 'draft') {
                            badge = `<span class="bg-red-100 text-red-600 text-xs px-2 py-1 rounded mr-2 font-bold uppercase tracking-wide border border-red-200">DRAFT</span>`;
                            opacityClass = 'opacity-60';
                        } else if (article.status === 'scheduled') {
                            const now = Date.now();
                            const scheduled = article.scheduledAt || 0;
                            if (now < scheduled) {
                                // Future
                                const dateStr = new Date(scheduled).toLocaleString();
                                badge = `<span class="bg-yellow-100 text-yellow-700 text-xs px-2 py-1 rounded mr-2 font-bold uppercase tracking-wide border border-yellow-200" title="Live at ${dateStr}">SCHEDULED</span>`;
                                opacityClass = 'opacity-80';
                            }
                            // If time has passed, NO BADGE. Just looks like normal live article.
                        }
                    }

                    // Series Tag Logic (With Part #)
                    let seriesHtml = '';
                    if (article.series) {
                        const partText = article.seriesPart ? ` // PART ${article.seriesPart}` : '';
                        const displayText = article.series + partText;
                        seriesHtml = `<div onclick="setSearch('${article.series.replace(/'/g, "\\'")}')" class="text-xs font-bold text-red-600 uppercase mb-1 cursor-pointer hover:underline tracking-wider">${displayText}</div>`;
                    }

                    // AUTOMATIC SUMMARY: Use manual summary if available, else auto-generate snippet
                    const summaryText = article.summary ? article.summary : getSnippet(article.content);
                    
                    const authorName = article.author || "Unknown";
                    // Clickable Author Link
                    const authorLink = `<a href="#author/${encodeURIComponent(authorName)}" class="hover:text-red-600 hover:underline transition-colors">${authorName}</a>`;

                    html += `
                <article class="flex flex-col sm:flex-row items-start border-b border-gray-200 pb-10 last:border-0 ${opacityClass}">
                    <a href="#article/${article.id}" class="flex-shrink-0 w-full sm:w-48 cursor-pointer group">
                        <img src="${article.imageUrl || "https://placehold.co/192x128/cccccc/000000?text=No+Image&font=inter"}"
                             alt="Thumbnail"
                             referrerpolicy="no-referrer"
                             onerror="this.onerror=null; this.src='https://placehold.co/192x128/cccccc/000000?text=Image+Unavailable';"
                             class="w-full h-48 sm:h-32 object-cover rounded mb-4 sm:mb-0 transition-all duration-300">
                    </a>
                    <div class="sm:ml-6 w-full">
                        ${seriesHtml}
                        <a href="#article/${article.id}"><h2 class="text-2xl font-bold mb-2 uppercase tracking-wide transition-colors cursor-pointer hover:text-gray-700">${badge}${article.title || "Untitled Article"}</h2></a>
                        <p class="text-base mb-3 text-gray-800">${summaryText}</p>
                        <div class="flex items-center space-x-3">
                            <a href="#article/${article.id}" class="bg-black text-white text-xs font-bold py-2 px-4 uppercase tracking-wider hover:bg-gray-800 transition-colors">Read More</a>
                            <span class="text-sm text-gray-600">by ${authorLink}</span>
                        </div>
                    </div>
                </article>`;
                });

                if (articlesToShow.length < filteredArticles.length) {
                    html += `<div id="scroll-trigger" class="text-center text-gray-500 py-8 font-bold">Scroll for more...</div>`;
                }
                html += `</div>`;
                mainContent.innerHTML = html;
            }

            function renderArticleDetail(id) {
                const article = allArticles.find((a) => a.id === id);
                
                if (!article) {
                    mainContent.innerHTML = `<div class="text-center mt-20 font-bold text-xl">Article not found (or loading...)</div>`;
                    return;
                }
                
                // Security Check
                if (!isArticleVisible(article)) {
                     mainContent.innerHTML = `<div class="text-center mt-20 text-red-600 font-bold text-xl">Access Denied: This article is not yet available.</div>`;
                     return;
                }

                const formattedContent = formatArticleText(article.content);

                let editBtn = "";
                let draftBanner = "";
                // Display date logic: Use scheduled date if available
                let displayDate = article.createdAt;
                if (article.status === 'scheduled' && article.scheduledAt) {
                    displayDate = article.scheduledAt;
                }

                if (currentUser) {
                    editBtn = `<a href="#edit/${article.id}" class="ml-4 text-sm font-bold uppercase text-blue-600 hover:text-blue-800">[EDIT ARTICLE]</a>`;
                    if (article.status === 'draft') {
                        draftBanner = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6 text-center font-bold">DRAFT MODE - Hidden from public</div>`;
                    } else if (article.status === 'scheduled') {
                        const now = Date.now();
                        const scheduled = article.scheduledAt || 0;
                        if (now < scheduled) {
                            const dateStr = new Date(scheduled).toLocaleString();
                            draftBanner = `<div class="bg-yellow-100 border border-yellow-400 text-yellow-800 px-4 py-3 rounded relative mb-6 text-center font-bold">SCHEDULED - Goes live: ${dateStr}</div>`;
                        }
                    }
                }
                
                // Series Banner in Article Detail (With Part #)
                let seriesBanner = '';
                if (article.series) {
                    const partText = article.seriesPart ? ` • PART ${article.seriesPart}` : '';
                    seriesBanner = `<div class="mb-6 text-center"><span class="inline-block bg-black text-white text-xs font-bold px-3 py-1 uppercase tracking-widest cursor-pointer hover:bg-red-600 transition-colors" onclick="setSearch('${article.series.replace(/'/g, "\\'")}')">SERIES: ${article.series}${partText}</span></div>`;
                }
                
                const authorName = article.author || "Unknown";
                const authorLink = `<a href="#author/${encodeURIComponent(authorName)}" class="hover:text-red-600 hover:underline transition-colors border-b border-transparent hover:border-red-600">${authorName}</a>`;

                mainContent.innerHTML = `
                <div class="fade-in pb-20 max-w-full">
                    ${draftBanner}
                    <div class="flex items-center mb-6">
                        <a href="#" class="inline-block text-sm font-bold uppercase border-b border-black hover:text-gray-700">← Back to Home</a>
                        ${editBtn}
                    </div>
                    
                    ${seriesBanner}

                    <h1 class="text-4xl sm:text-6xl font-bold uppercase mb-4 font-title-custom leading-tight break-words">${article.title}</h1>
                    <div class="flex items-center space-x-2 text-sm text-gray-600 mb-8 border-b border-black pb-4">
                        <span class="font-bold text-black uppercase">By ${authorLink}</span><span>•</span><span>${new Date(displayDate).toLocaleDateString()}</span>
                    </div>
                    <img src="${article.imageUrl || "https://placehold.co/800x400/cccccc/000000?text=No+Image"}" 
                         referrerpolicy="no-referrer"
                         class="w-full h-auto max-h-[500px] object-cover mb-8 rounded shadow-sm">

                    <div class="article-body font-inter text-gray-800 text-lg">
                        ${formattedContent}
                    </div>
                </div>`;
            }

            // --- BACKUP FUNCTIONALITY ---
            window.downloadBackup = async function() {
                try {
                    // Show a simple alert or toast
                    alert("Generating backup... this may take a moment.");
                    
                    const articlesRef = collection(db, "articles");
                    const snapshot = await getDocs(articlesRef);
                    
                    const data = [];
                    snapshot.forEach((doc) => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Convert to JSON
                    const json = JSON.stringify(data, null, 2);
                    const blob = new Blob([json], { type: "application/json" });
                    const url = URL.createObjectURL(blob);
                    
                    // Create temporary link and click it
                    const a = document.createElement('a');
                    a.href = url;
                    const dateStr = new Date().toISOString().slice(0, 10);
                    a.download = `jcjournal_backup_${dateStr}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                } catch (error) {
                    console.error("Backup failed:", error);
                    alert("Backup failed. Check console.");
                }
            };

            function renderLoginForm() {
                if (currentUser && !currentUser.isAnonymous) {
                    mainContent.innerHTML = `
                    <div class="fade-in max-w-md mx-auto bg-white p-8 border-2 border-black mb-20 mt-10 text-center">
                        <h2 class="text-2xl font-bold uppercase mb-4 font-title-custom">You are logged in</h2>
                        <p class="mb-6">Welcome, ${currentUser.email}</p>
                        <a href="#submit" class="block w-full bg-black text-white font-bold uppercase py-3 px-8 hover:bg-gray-800 transition-colors mb-4">Submit Article</a>
                        <a href="#" class="block w-full border-2 border-black text-black font-bold uppercase py-3 px-8 hover:bg-gray-100 transition-colors">Go Home</a>
                        <button onclick="downloadBackup()" class="block w-full mt-4 border-2 border-gray-400 text-gray-600 font-bold uppercase py-3 px-8 hover:bg-gray-100 transition-colors">Download Database Backup</button>
                        <button onclick="window.location.hash='#logout'" class="block w-full mt-4 border-2 border-red-500 text-red-500 font-bold uppercase py-3 px-8 hover:bg-red-50 transition-colors">Log Out</button>
                    </div>
                `;
                    return;
                }

                mainContent.innerHTML = `
                <div class="fade-in max-w-md mx-auto bg-white p-8 border-2 border-black mb-20 mt-10">
                    <h2 class="text-3xl font-bold uppercase mb-6 text-center font-title-custom">Staff Login</h2>
                    <form id="login-form" class="space-y-4">
                        <div><label class="block text-xs font-bold uppercase mb-1">Email</label><input type="email" id="email" required class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500"></div>
                        <div><label class="block text-xs font-bold uppercase mb-1">Password</label><input type="password" id="password" required class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500"></div>
                        <div class="pt-4"><button type="submit" class="w-full bg-black text-white font-bold uppercase py-3 px-8 hover:bg-gray-800 transition-colors">Login</button></div>
                        <p id="login-error" class="text-red-500 text-center text-sm font-bold mt-2"></p>
                    </form>
                </div>`;
                document
                    .getElementById("login-form")
                    .addEventListener("submit", async (e) => {
                        e.preventDefault();
                        const errBox = document.getElementById("login-error");
                        errBox.textContent = "Logging in...";
                        try {
                            const cred = await signInWithEmailAndPassword(
                                auth,
                                document.getElementById("email").value,
                                document.getElementById("password").value,
                            );
                            currentUser = cred.user;
                            updateFooterState();
                            setTimeout(() => {
                                window.location.hash = "";
                            }, 200);
                        } catch (error) {
                            let msg = "Invalid email or password.";
                            if (error.code === "auth/invalid-credential")
                                msg = "Incorrect email or password.";
                            errBox.textContent = msg;
                        }
                    });
            }

            function renderSubmitForm(editId = null) {
                let authorName = "";
                if (currentUser && currentUser.email) {
                    const email = currentUser.email.toLowerCase();
                    if (email.includes("jack")) authorName = "Jack Pendry";
                    else if (email.includes("connor"))
                        authorName = "Connor O'Donnell";
                    else authorName = "Staff Writer";
                }

                let existingArticle = null;
                let formTitle = "Submit New Article";
                let btnText = "Publish";
                let deleteButton = "";
                let scheduleContainerClass = 'hidden';

                if (editId) {
                    existingArticle = allArticles.find((a) => a.id === editId);
                    if (existingArticle) {
                        formTitle = "Edit Article";
                        btnText = "Update Article";
                        authorName = existingArticle.author || authorName;
                        deleteButton = `<button type="button" id="delete-btn" class="w-full sm:w-auto border-2 border-red-500 text-red-500 font-bold uppercase py-3 px-8 hover:bg-red-50 transition-colors">Delete Article</button>`;
                        
                        if (existingArticle.status === 'scheduled') {
                            scheduleContainerClass = ''; 
                        }
                    }
                }
                
                const currentStatus = existingArticle ? (existingArticle.status || 'published') : 'published';
                const selPublished = currentStatus === 'published' ? 'selected' : '';
                const selDraft = currentStatus === 'draft' ? 'selected' : '';
                const selScheduled = currentStatus === 'scheduled' ? 'selected' : '';
                
                let scheduleVal = '';
                if (existingArticle && existingArticle.scheduledAt) {
                    const date = new Date(existingArticle.scheduledAt);
                    const offset = date.getTimezoneOffset() * 60000;
                    scheduleVal = new Date(date.getTime() - offset).toISOString().slice(0, 16);
                }

                mainContent.innerHTML = `
                <div class="fade-in max-w-2xl mx-auto bg-white p-8 border-2 border-black mb-20">
                    <h2 class="text-3xl font-bold uppercase mb-6 text-center font-title-custom">${formTitle}</h2>
                    ${editId ? '' : '<div class="bg-blue-100 text-blue-700 text-xs font-bold p-2 mb-4 rounded text-center hidden" id="restore-msg">Unsaved draft restored.</div>'}
                    <form id="article-form" class="space-y-4">
                        <div><label class="block text-xs font-bold uppercase mb-1">Article Title</label><input type="text" id="title" required class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500 font-mono text-sm placeholder-gray-400" placeholder="e.g. THE STATE OF THE WORLD" value="${existingArticle ? existingArticle.title : ""}"></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div><label class="block text-xs font-bold uppercase mb-1">Author Name</label><input type="text" id="author" required class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500" placeholder="Your Name" value="${authorName}"></div>
                            <div><label class="block text-xs font-bold uppercase mb-1">Image URL</label><input type="text" id="imageUrl" placeholder="https://..." class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500 font-mono text-sm" value="${existingArticle ? existingArticle.imageUrl : ""}"><p class="text-[10px] text-gray-500 mt-1">Paste a link to an image (Imgur, etc)</p></div>
                        </div>
                        
                        <!-- SERIES ROW -->
                        <div class="grid grid-cols-4 gap-4">
                            <div class="col-span-3">
                                <label class="block text-xs font-bold uppercase mb-1">Series Name (Optional)</label>
                                <input type="text" id="series" class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500 font-mono text-sm" placeholder="e.g. The Balkan Trip" value="${existingArticle ? existingArticle.series || '' : ''}">
                            </div>
                            <div class="col-span-1">
                                <label class="block text-xs font-bold uppercase mb-1">Part #</label>
                                <input type="text" id="seriesPart" class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500 font-mono text-sm" placeholder="#" value="${existingArticle ? existingArticle.seriesPart || '' : ''}">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold uppercase mb-1">Status</label>
                                <select id="status" class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500 bg-white font-mono text-sm">
                                    <option value="published" ${selPublished}>Published</option>
                                    <option value="draft" ${selDraft}>Draft</option>
                                    <option value="scheduled" ${selScheduled}>Scheduled</option>
                                </select>
                            </div>
                            <div id="schedule-container" class="${scheduleContainerClass}">
                                <label class="block text-xs font-bold uppercase mb-1">Go Live Date/Time</label>
                                <input type="datetime-local" id="scheduledAt" class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500 font-mono text-sm" value="${scheduleVal}">
                            </div>
                        </div>

                        <!-- Manual Summary Box Restored -->
                        <div><label class="block text-xs font-bold uppercase mb-1">Short Summary</label><textarea id="summary" rows="2" required class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500" placeholder="Appears on the homepage...">${existingArticle ? existingArticle.summary : ""}</textarea></div>

                        <div><label class="block text-xs font-bold uppercase mb-1">Full Content</label><textarea id="content" rows="15" required class="w-full border-2 border-black p-2 focus:outline-none focus:border-red-500 font-mono text-sm" placeholder="Write here. Use - or * for automatic lists. Use **bold** for bold text. Use IMAGE: URL | Caption | Copyright for images.">${existingArticle ? existingArticle.content : ""}</textarea><p class="text-[10px] text-gray-500 mt-1">Start a line with - or * to create a bullet list. Use **text** for bold. Start a line with IMAGE: https://... | Caption | Copyright to insert an image.</p></div>

                        <div class="pt-4 flex flex-col sm:flex-row justify-between items-center gap-4">
                            <div class="flex flex-col sm:flex-row gap-4 items-center">
                                <a href="#" class="text-sm font-bold uppercase hover:text-red-500">Cancel</a>
                                <span id="autosave-status" class="text-xs text-gray-400 italic"></span>
                            </div>
                            <div class="flex gap-4 items-center">
                                ${deleteButton}
                                <button type="submit" class="w-full sm:w-auto bg-black text-white font-bold uppercase py-3 px-8 hover:bg-gray-800 transition-colors">${btnText}</button>
                            </div>
                        </div>
                        <p id="submit-msg" class="text-center font-bold text-sm mt-2"></p>
                    </form>
                </div>`;
                
                const statusSelect = document.getElementById('status');
                const scheduleContainer = document.getElementById('schedule-container');
                statusSelect.addEventListener('change', (e) => {
                    if (e.target.value === 'scheduled') {
                        scheduleContainer.classList.remove('hidden');
                    } else {
                        scheduleContainer.classList.add('hidden');
                    }
                });

                // AUTOSAVE LOGIC
                const storageKey = editId ? `jc_draft_${editId}` : `jc_draft_new`;
                const savedDraft = JSON.parse(localStorage.getItem(storageKey) || 'null');
                const statusLabel = document.getElementById('autosave-status');
                
                const inputs = document.querySelectorAll('#article-form input, #article-form textarea, #article-form select');
                inputs.forEach(input => {
                    input.addEventListener('input', () => {
                        const draftData = {
                            title: document.getElementById("title").value,
                            summary: document.getElementById("summary").value,
                            content: document.getElementById("content").value,
                            status: document.getElementById("status").value,
                            series: document.getElementById("series").value,
                            seriesPart: document.getElementById("seriesPart").value,
                        };
                        localStorage.setItem(storageKey, JSON.stringify(draftData));
                        
                        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        statusLabel.textContent = `Autosaved at ${time}`;
                    });
                });
                
                if (savedDraft && !existingArticle) {
                    document.getElementById("title").value = savedDraft.title || "";
                    document.getElementById("summary").value = savedDraft.summary || "";
                    document.getElementById("content").value = savedDraft.content || "";
                    document.getElementById("series").value = savedDraft.series || "";
                    document.getElementById("seriesPart").value = savedDraft.seriesPart || "";
                    document.getElementById("restore-msg").classList.remove("hidden");
                }

                if (editId) {
                    document.getElementById("delete-btn").addEventListener("click", async () => {
                        if (confirm("Are you sure you want to delete this article? This cannot be undone.")) {
                            try {
                                await deleteDoc(doc(db, "articles", editId));
                                localStorage.removeItem(storageKey); 
                                alert("Article Deleted Successfully.");
                                window.location.hash = "";
                            } catch (error) {
                                console.error("Error deleting document: ", error);
                                alert("Error deleting article: " + error.message);
                            }
                        }
                    });
                }

                document
                    .getElementById("article-form")
                    .addEventListener("submit", async (e) => {
                        e.preventDefault();
                        const btn = e.target.querySelector("button[type='submit']");
                        const msgBox = document.getElementById("submit-msg");

                        btn.textContent = "Processing...";
                        btn.disabled = true;
                        msgBox.className =
                            "text-center font-bold text-sm mt-2 text-gray-500";
                        msgBox.textContent = "";

                        try {
                            const status = document.getElementById("status").value;
                            let scheduledTimestamp = null;
                            
                            if (status === 'scheduled') {
                                const dateVal = document.getElementById("scheduledAt").value;
                                if (dateVal) {
                                    scheduledTimestamp = new Date(dateVal).getTime();
                                } else {
                                    throw new Error("Please select a date for the scheduled post.");
                                }
                            }

                            const data = {
                                title: document.getElementById("title").value,
                                author: document.getElementById("author").value,
                                imageUrl:
                                    document.getElementById("imageUrl").value,
                                summary: document.getElementById("summary").value, // Manual summary restored
                                content:
                                    document.getElementById("content").value,
                                series: document.getElementById("series").value,
                                seriesPart: document.getElementById("seriesPart").value,
                                status: status,
                                scheduledAt: scheduledTimestamp,
                                isGrayscale: false,
                            };
                            
                            if (status === 'published' && editId) {
                                const oldArt = allArticles.find(a => a.id === editId);
                                if (oldArt && oldArt.scheduledAt) {
                                    data.createdAt = oldArt.scheduledAt;
                                    data.scheduledAt = null;
                                }
                            }

                            if (editId) {
                                const docRef = doc(db, "articles", editId);
                                await updateDoc(docRef, data);
                                localStorage.removeItem(storageKey); 
                                msgBox.className =
                                    "text-center font-bold text-sm mt-2 text-green-600";
                                msgBox.textContent =
                                    "Article updated successfully!";
                                setTimeout(() => {
                                    window.location.hash = `#article/${editId}`;
                                }, 1000);
                            } else {
                                if (!data.createdAt) {
                                    data.createdAt = Date.now();
                                }
                                data.submitterId = currentUser.uid;
                                await addDoc(collection(db, "articles"), data);
                                localStorage.removeItem(storageKey); 
                                msgBox.className =
                                    "text-center font-bold text-sm mt-2 text-green-600";
                                msgBox.textContent =
                                    "Article published successfully!";
                                setTimeout(() => {
                                    window.location.hash = "";
                                }, 1000);
                            }
                        } catch (error) {
                            console.error("Error submitting:", error);
                            let msg = error.code || error.message;
                            if (error.code === "permission-denied")
                                msg =
                                    "Permission Denied. You may not be authorized to write.";

                            msgBox.className =
                                "text-center font-bold text-sm mt-2 text-red-500";
                            msgBox.textContent = `Error: ${msg}`;

                            btn.textContent = btnText;
                            btn.disabled = false;
                        }
                    });
            }

            searchInput.addEventListener("input", () => {
                displayedCount = 5;
                if (currentView === "home") renderHome();
            });

            window.addEventListener("scroll", () => {
                if (currentView !== "home") return;
                const st = document.getElementById("scroll-trigger");
                if (st) {
                    const rect = st.getBoundingClientRect();
                    if (rect.top < window.innerHeight + 100) {
                        if (displayedCount < allArticles.length) {
                            displayedCount += 5;
                            renderHome();
                        }
                    }
                }
            });

            init();
        </script>
    </body>
</html>